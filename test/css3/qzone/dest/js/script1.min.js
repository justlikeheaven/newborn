module.exports=function(a){require("load-grunt-tasks")(a),a.file.defaultEncoding="GBK";var b="src/",c="dest/";a.initConfig({clean:{release:["dest",".temp"]},copy:{html:{expand:!0,cwd:b,src:["**"],dest:c}},inline:{options:{uglify:!0},dist:{src:c+"/inline/*.html"},dist2:{src:c+"/*.html"}},cssmin:{options:{noAdvanced:!0}},concat:{options:{separator:"\n"}},uglify:{options:{DEBUG:!0}},useminPrepare:{top:{src:[b+"**/*.{shtml,html}","!"+b+"appbox/**","!"+b+"wallet/**"],options:{dest:c}},appbox:{src:[b+"appbox/**/*.{shtml,html}"],options:{root:b+"appbox/v3",dest:c+"appbox/v3"}},wallet:{src:[b+"wallet/**/*.{shtml,html}"],options:{root:b+"wallet/v3",dest:c+"wallet/v3"}}},rev:{options:{algorihtm:"md5",length:8,encoding:"GBK"},js:{files:[{src:[c+"/{**,!static_res}/*.min.{js,css}",c+"/static_res/**/*.{js,css,png,jpg,gif,ico}"]}]}},usemin:{options:{assetsDirs:[c,c+"appbox/v3",c+"wallet/v3"],patterns:{js:[[/(\/[\/\w-]+\.{1}(gif|jpg|png))/g,"replace image in js"]]}},html:[c+"/**/*.{html,shtml}"],css:[c+"/static_res/**/*.css"],js:[c+"/static_res/**/*.js"]},replace:{dist:{options:{usePrefix:!1,patterns:[{json:{"/static_res/":"http://jipiao.qq.com/"}}]},files:[{expand:!0,src:[c+"**/*.{html,shtml,js,css}","!**/node_modules/**","!"+c+"login/**"]}]}},imageoptim:{dist:{options:{optimizationLevel:1},files:[{expand:!0,cwd:c,src:["**/*.{png,jpg,jpeg}"],dest:c}]}},requirejs:{options:{optimize:"uglify2",generateSourceMaps:!0,preserveLicenseComments:!1},compile:{options:{baseUrl:"src/tests/backbone/scripts",paths:{jquery:"lib/jquery",underscore:"lib/underscore",backbone:"lib/backbone",text:"lib/text"},shim:{jquery:{exports:"$"},underscore:{deps:["jquery"],exports:"_"},backbone:{deps:["underscore","jquery"],exports:"Backbone"}},name:"init",dir:"v3/scripts"}}},compress:{prod:{options:{archive:'pc-<%= grunt.template.today("yyyy-mm-dd-hh-MM") %>.tar.gz'},expand:!0,cwd:c,src:["**","!doc/**"]},act:{options:{archive:'pc-<%= grunt.template.today("yyyy-mm-dd-hh-MM") %>.tar.gz'},expand:!0,cwd:b,src:["act/**"]},static_res:{options:{archive:'pc-static_res-<%= grunt.template.today("yyyy-mm-dd-hh-MM") %>.tar.gz'},expand:!0,cwd:c,src:["static_res/**"]}},uglify:{options:{compress:!1}}}),a.registerTask("default",["clean","copy","inline","useminPrepare","concat:generated","cssmin","uglify:generated","rev","usemin"]),a.registerTask("release",["getToken","getPurpose","default","replace","compress:prod","e2e"]),a.registerTask("releaseAct",["compress:act"]),a.registerTask("testCopy",function(){var b=a.file.readJSON("grunt_task/test.json");a.config.set("copy",{copy:b.copy.target}),console.log("test参数："+JSON.stringify(a.config())),a.task.run("copy")});var d=require("readline");a.registerTask("getToken",function(){var b=require("./e2e/user.conf.json");b.name&&a.log.error("请在user.conf.json文件中配置账号密码");var c=this.async(),e=d.createInterface({input:process.stdin,output:process.stdout});e.question("hi,请输入6位token密码: ",function(b){a.config("token",b),e.close(),c()})}),a.registerTask("getPurpose",function(){var b=this.async(),c=d.createInterface({input:process.stdin,output:process.stdout});c.question("请输入发布目的: ",function(d){a.config("purpose",d),c.close(),b()})}),a.registerTask("e2e",function(){var b=this.async();a.util.spawn({cmd:"node",args:["e2e/release",a.config("token"),a.config("purpose")]},function(c,d){b(),c?a.log.error(c):(a.log.oklns("success"),a.log.writeln(d))})})};