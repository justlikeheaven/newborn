<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>cannonBall-1</title>
</head>
<body onload="init()">
<canvas id="canvas" width="600" height="400">不支持显示</canvas>

<form name="control" id="control">
    <label for="speed">速度：</label><input type="number" name="speed" id="speed" value="10" min="-100" max="100"/>
    <label for="angle">角度：</label><input type="number" name="angle" id="angle" value="10" min="0" max="80"/>
    <input type="button" onclick="fire()"/>
</form>
<script>
    // 目标改成大炮图片
    var cWidth = 600;
    var cHeight = 400;
    var ctx;
    var tid; //定时事件标识符的变量
    var xSpeed; //水平位移
    var ySpeed1; // 间隔开始时的垂直速度
    var ySpeed2; // 间隔结束时的垂直速度
    var quick = 2; //加速度
    var ballrad = 10;
    // 炮弹
    var cannonX = 10;
    var cannonY = 280;
    var cannonLength = 200;
    var cannonHeight = 20;
    // 目标
    var targetX = 300;
    var targetY = 50;
    var targetWidth = 85;
    var targetHeight = 280;
    // 命中目标
    var hitTargetX = 450;
    var hitTargetY = 220;
    var hitTargetWidth = 355;
    var hitTargetHeight = 96;

    var cBall = new Ball(cannonX + cannonLength, cannonY + cannonHeight * .5, ballrad, "#ff6600");
    var target = new picture(targetX, targetY, targetWidth, targetHeight, "http://wenwen.sogou.com/p/20120304/20120304205823-858720231.jpg"); //目标人物
    var hitTarget = new picture(hitTargetX, hitTargetY, hitTargetWidth, hitTargetHeight, "http://picapi.ooopic.com/11/19/76/59b1OOOPIC43.jpg");
    var ground = new MyRectangle(0, 300, 600, 30, "#333333");
    var cannon = new MyRectangle(cannonX, cannonY, cannonLength, cannonHeight, "#ff0000");
    var everything = [];
    everything.push([target, false]);
    var targetIndex = everything.length;
    everything.push([ground, false]);
    var ballIndex = everything.length;
    everything.push([cBall, false]);
    var cannonIndex = everything.length;
    everything.push([cannon, true, 0, cannonX, cannonY + cannonHeight * .5]);



    // 初始化
    function init() {
        ctx = document.getElementById("canvas").getContext("2d");
        drawAll(); //绘制所有对象
    }

    function drawAll() {
        ctx.clearRect(0, 0, cWidth, cHeight); //擦除画布
        for (var i = 0; i < everything.length; i++) {
            var obj = everything[i];
            if (obj[1]) {
                ctx.save();
                ctx.translate(obj[3], obj[4]);
                ctx.rotate(obj[2]);
                ctx.translate(-obj[3], -obj[4]);
                obj[0].draw();
                ctx.restore();
            } else {
                obj[0].draw();
            }
        }
    }

    function fire() {
        tid && clearInterval(tid); // 停止运动
        var angle = Number(document.control.angle.value);
        var outofSpeed = Number(document.control.speed.value);
        var anglerRadian = angle * Math.PI / 180;
        xSpeed = outofSpeed * Math.cos(anglerRadian);
        ySpeed1 = -outofSpeed * Math.sin(anglerRadian);
        everything[cannonIndex][2] = -anglerRadian;
        cBall.sx = cannonY + cannonHeight * .5 - cannonLength * Math.sin(anglerRadian);
        drawAll()
        //console.log("line48:ySpeed1:"+ySpeed1);
        tid = setInterval(change, 100);
        return false;
    }

    function change() {
        var dx = xSpeed;
        ySpeed2 = ySpeed1 + quick;  //时间间隔结束时的垂直速度
        var dy = (ySpeed1 + ySpeed2) * .3; //时间间隔的垂直位移
        ySpeed1 = ySpeed2;
        cBall.moveIt(dx, dy);
        console.log("line59:dy:" + dy); //todo 在一次弹跳动作未完成又重复点击会造成垂直速度累加！
        // 子弹在目标的水平范围和垂直范围内
        if ((cBall.sx >= target.sx)
                && (cBall.sx <= target.sx + target.sWidth)
                && (cBall.sy >= target.sy)
                && (cBall.sy <= target.sy + target.sHeight)) {
            console.log('[close]');
            clearInterval(tid); // 停止运动
            everything.splice(targetIndex, 1, [hitTarget, false]);
            everything.splice(ballIndex, 1);
            drawAll();
        }
        if (cBall.sy >= ground.sy) {
            clearInterval(tid)
        }
    }

    function Ball(sx, sy, rad, styleString) {
        this.sx = sx;
        this.sy = sy;
        this.rad = rad;
        this.draw = drawBall;
        this.moveIt = moveBall;
        this.fillStyle = styleString;
    }

    function MyRectangle(sx, sy, sWidth, sHeight, styleString) {
        this.sx = sx;
        this.sy = sy;
        this.sWidth = sWidth;
        this.sHeight = sHeight;
        this.fillStyle = styleString;
        this.draw = drawRects;
        this.moveIt = moveBall;
    }

    // 绘制一个填充的圆
    function drawBall() {
        ctx.fillStyle = this.fillStyle;
        ctx.beginPath();
        ctx.arc(this.sx, this.sy, this.rad, 0, Math.PI * 2, true);
        ctx.closePath();
        ctx.fill();
    }

    function drawRects() {
        ctx.fillStyle = this.fillStyle;
        ctx.fillRect(this.sx, this.sy, this.sWidth, this.sHeight);
    }

    function picture(sx, sy, sWidth, sHeight, name) {
        var imga = new Image();
        imga.src = name;
        this.sx = sx;
        this.sy = sy;
        this.img = imga;
        this.sWidth = sWidth;
        this.sHeight = sHeight;
        this.draw = drawAnImage;
        this.moveIt = moveBall;
    }

    function drawAnImage() {
        ctx.drawImage(this.img, this.sx, this.sy, this.sWidth, this.sHeight);
    }

    // 改变对象在应用中的位置
    function moveBall(dx, dy) {
        this.sx += dx;
        this.sy += dy;
        //console.log("line108:dx:"+dx+"-----dy:"+dy)
    }


</script>
</body>
</html>